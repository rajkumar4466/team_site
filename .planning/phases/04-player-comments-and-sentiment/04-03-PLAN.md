---
phase: 04-player-comments-and-sentiment
plan: 03
type: execute
wave: 3
depends_on:
  - "04-01"
  - "04-02"
files_modified: []
autonomous: false
requirements:
  - COMM-01
  - COMM-02
  - COMM-03
  - COMM-04

must_haves:
  truths:
    - "User can submit a comment on a player profile without logging in"
    - "Submitted comment is classified by HuggingFace and the sentiment label is stored and shown"
    - "Comment list on player profile page shows each comment's text and sentiment label"
    - "Sentiment badge below the hero photo area shows accurate green/red/grey counts"
    - "Badge counts update after new comments are submitted (no page reload required)"
  artifacts:
    - path: "src/app/players/[slug]/page.tsx"
      provides: "Player profile page with CommentSection integrated"
      contains: "CommentSection"
    - path: "src/components/CommentSection.tsx"
      provides: "Interactive comment form, list, and sentiment badge"
      exports: ["CommentSection"]
    - path: "src/app/api/comments/route.ts"
      provides: "Working GET and POST handlers for comments"
      exports: ["GET", "POST"]
  key_links:
    - from: "CommentSection (browser)"
      to: "/api/comments POST"
      via: "form submit handler"
      pattern: "fetch.*POST.*api/comments"
    - from: "/api/comments POST"
      to: "HuggingFace Inference API"
      via: "server-side fetch in route.ts"
      pattern: "router.huggingface.co/hf-inference/models/cardiffnlp"
---

<objective>
Human verification of the complete player comments and sentiment feature.

Purpose: Confirms that all four COMM requirements are satisfied end-to-end — anonymous comment submission, HuggingFace sentiment classification, comment display with labels, and the sentiment summary badge. This is the acceptance gate for Phase 4.

Output: Human-verified phase completion; SUMMARY.md written.
</objective>

<execution_context>
@/Users/mithra_sundaram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mithra_sundaram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-player-comments-and-sentiment/04-01-SUMMARY.md
@.planning/phases/04-player-comments-and-sentiment/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start dev server and confirm build</name>
  <files></files>
  <action>
    Run `npm run build` to confirm no TypeScript or build errors. Then run `npm run dev` to start the development server.

    Before the human verification checkpoint, also confirm the server starts without errors by checking the terminal output for "Ready" message.

    If `npm run build` fails:
    - Check for TypeScript errors with `npx tsc --noEmit`
    - Check that `next.config.ts` has no `output: 'export'` line
    - Check that `src/app/api/comments/route.ts` exists

    If `.env.local` does not exist yet, remind the user to create it with their HUGGINGFACE_API_KEY before the verification step. The format is documented in `.env.local.example`.
  </action>
  <verify>`npm run build` exits with code 0 and `npm run dev` shows "Ready" in terminal output</verify>
  <done>Build succeeds and dev server is running at http://localhost:3000</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — commenting, sentiment, and badge</name>
  <action>
    Pause for human to verify the complete Phase 4 feature end-to-end. All automated work is complete. This task confirms all COMM requirements are satisfied visually and functionally.

    PREREQUISITE: .env.local must contain HUGGINGFACE_API_KEY. See .env.local.example for the format and token generation URL (https://huggingface.co/settings/tokens/new).
  </action>
  <verify>Human types "approved" after testing all 4 COMM requirements</verify>
  <done>Human confirms COMM-01 through COMM-04 all pass visual and functional verification</done>
  <what-built>
    Complete Phase 4 feature — anonymous commenting with AI sentiment classification on every KKR player profile.

    What was implemented:
    - Removed `output: 'export'` from next.config.ts to enable POST Route Handlers
    - Created Comment types (src/types/comment.ts) and in-memory store (src/data/comments.ts)
    - Created /api/comments Route Handler (GET + POST with HuggingFace classification)
    - Created CommentSection client component with form, comment list, and sentiment badge
    - Integrated CommentSection into every player profile page below the hero grid
    - Model used: cardiffnlp/twitter-roberta-base-sentiment-latest (HF Inference API via router.huggingface.co)

    PREREQUISITE: .env.local must contain your HUGGINGFACE_API_KEY. See .env.local.example for the format and token generation URL.
  </what-built>
  <how-to-verify>
    **Step 1 — Confirm .env.local has your HuggingFace API key**
    - Check that `.env.local` exists and contains `HUGGINGFACE_API_KEY=hf_...`
    - If not: visit https://huggingface.co/settings/tokens/new?ownUserPermissions=inference.serverless.write&tokenType=fineGrained
    - Create a token with "Inference Providers" permission and add it to `.env.local`
    - Restart `npm run dev` after adding the key

    **Step 2 — Navigate to a player profile**
    - Visit: http://localhost:3000/players/rohit-sharma (or any player)
    - Expected: Player profile page loads with player name, photo placeholder, bio, and stats
    - Expected: Below the hero grid, you see a "Fan Sentiment" badge (0 Positive, 0 Neutral, 0 Negative)
    - Expected: Below the badge, a "Leave a Comment" section with a textarea and "Post Comment" button
    - Expected: "Comments (0)" section with "No comments yet" message

    **Step 3 — Submit a positive comment (COMM-01, COMM-02, COMM-03)**
    - Type in the textarea: "Rohit Sharma is an absolute legend! Outstanding batting!"
    - Click "Post Comment"
    - Expected while submitting: Button shows "Posting..." and textarea is disabled
    - Expected after ~2-10 seconds (HF inference time): Comment appears in the list with a green "positive" badge
    - Expected: Sentiment badge updates to show "1 Positive"

    **Step 4 — Submit a negative comment**
    - Type: "Disappointing performance, dropped catches and poor form recently"
    - Click "Post Comment"
    - Expected: Comment appears with a red "negative" badge
    - Expected: Sentiment badge updates to show "1 Positive, 0 Neutral, 1 Negative"

    **Step 5 — Submit a neutral comment**
    - Type: "Rohit Sharma plays for KKR and bats in the top order"
    - Click "Post Comment"
    - Expected: Comment appears with a grey "neutral" badge
    - Expected: Sentiment badge shows "1 Positive, 1 Neutral, 1 Negative"

    **Step 6 — Test another player**
    - Visit: http://localhost:3000/players/andre-russell (or another player slug)
    - Expected: Fresh page with empty comments (0 counts) — comments are per-player

    **Step 7 — COMM-04 badge placement check**
    - On any player profile page, confirm the "Fan Sentiment" badge appears BELOW the player photo area and ABOVE the comment form
    - On desktop: The badge should appear below the two-column hero (photo + bio) section, spanning full width

    **If HF model is warming up (503 error):**
    - Expected: Error message "Sentiment service is warming up. Please try again in 30 seconds."
    - Wait 30 seconds and retry — model will be warm on second attempt
  </how-to-verify>
  <resume-signal>
    Type "approved" if all 4 COMM requirements are visually confirmed.
    Or describe any issues found (e.g., "badge not updating", "wrong sentiment", "API error", "badge placement wrong").
  </resume-signal>
</task>

</tasks>

<verification>
COMM-01: User submitted comment without any login — VERIFIED
COMM-02: Comment classified as positive/negative/neutral via HuggingFace BERT — VERIFIED
COMM-03: Comment form and comment list with sentiment labels visible on player profile — VERIFIED
COMM-04: Sentiment summary badge below photo area shows green/red/grey counts — VERIFIED
</verification>

<success_criteria>
- Anonymous comment submission works on any player profile (COMM-01)
- HuggingFace cardiffnlp model classifies comments correctly (COMM-02)
- Comment form and list with labels visible on player profile page (COMM-03)
- Sentiment badge shows accurate positive/negative/neutral counts below hero area (COMM-04)
- Human approves all four COMM requirements
</success_criteria>

<output>
After completion, create `.planning/phases/04-player-comments-and-sentiment/04-03-SUMMARY.md`
</output>
