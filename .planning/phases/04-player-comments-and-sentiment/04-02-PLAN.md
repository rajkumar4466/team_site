---
phase: 04-player-comments-and-sentiment
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/components/CommentSection.tsx
  - src/app/players/[slug]/page.tsx
autonomous: true
requirements:
  - COMM-03
  - COMM-04

must_haves:
  truths:
    - "Player profile page shows a CommentSection below the two-column hero grid"
    - "CommentSection loads existing comments on mount via GET /api/comments?playerId=X"
    - "User can type and submit a comment via a textarea + submit button"
    - "After submission, the new comment appears in the list without page reload"
    - "Sentiment badge below the photo area shows green/red/grey counts for positive/negative/neutral"
    - "Each comment in the list shows its text and sentiment label (colored)"
    - "Submitting state is shown while the HF API call is in-flight"
    - "Error message shown if submission fails or HF service is warming up"
  artifacts:
    - path: "src/components/CommentSection.tsx"
      provides: "Client component with comment form, comment list, and sentiment badge"
      exports: ["CommentSection"]
    - path: "src/app/players/[slug]/page.tsx"
      provides: "Player profile page with CommentSection integrated below hero grid"
      contains: "CommentSection"
  key_links:
    - from: "src/components/CommentSection.tsx"
      to: "/api/comments"
      via: "fetch in useEffect (GET) and handleSubmit (POST)"
      pattern: "fetch.*api/comments"
    - from: "src/app/players/[slug]/page.tsx"
      to: "src/components/CommentSection.tsx"
      via: "import and render after closing grid div"
      pattern: "<CommentSection playerId"
---

<objective>
Add the CommentSection client component and integrate it into every player profile page.

Purpose: This plan creates the interactive client component that users see and interact with — comment form, comment list, and sentiment badge. It wires this component into the existing server component player profile page so every player profile gains the full commenting experience.

Output: CommentSection component at src/components/CommentSection.tsx and an updated player profile page that renders it below the hero.
</objective>

<execution_context>
@/Users/mithra_sundaram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mithra_sundaram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/players/[slug]/page.tsx
@.planning/phases/04-player-comments-and-sentiment/04-01-SUMMARY.md

<interfaces>
<!-- Types from 04-01 (src/types/comment.ts) -->
```typescript
export type Sentiment = "positive" | "neutral" | "negative";

export interface Comment {
  id: string;
  playerId: string;
  text: string;
  sentiment: Sentiment;
  createdAt: string; // ISO 8601 string
}
```

<!-- API contract from 04-01 (src/app/api/comments/route.ts) -->
// GET /api/comments?playerId={slug}
// Response: { comments: Comment[] }

// POST /api/comments
// Body: { playerId: string, text: string }
// Response 201: { comment: Comment }
// Response 400: { error: string }
// Response 503: { error: string, estimated_time?: number }

<!-- Current player profile page structure (from src/app/players/[slug]/page.tsx) -->
// Pure server component. Two-column hero grid ends at line 97 with </div>.
// CommentSection must be added AFTER the closing </div> of the grid,
// as a full-width sibling — NOT inside the left or right column.
// The slug from params is the playerId to pass to CommentSection.

<!-- KKR brand colors available (from globals.css via Tailwind v4 @theme) -->
// bg-kkr-purple, text-kkr-purple, text-kkr-gold, bg-kkr-purple-dark, bg-kkr-purple-light
// These are Tailwind utilities defined via CSS @theme in globals.css
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentSection client component</name>
  <files>
    src/components/CommentSection.tsx
  </files>
  <action>
    Create `src/components/CommentSection.tsx` as a "use client" component. It manages all comment state internally and calls the API routes from 04-01.

    **Placement note from research:** The sentiment badge is at the TOP of CommentSection (so it appears visually below the photo area when CommentSection is placed after the hero grid). The comment form comes next, then the comment list.

    **Key requirements:**
    - Fetch existing comments on mount (GET /api/comments?playerId=X)
    - Submit new comment via POST (show loading state, clear textarea on success)
    - Handle HF 503 cold start: show "Sentiment service is warming up. Please try again in 30 seconds."
    - Handle any other error: show "Could not submit comment. Please try again."
    - Derive sentiment counts from the comments array (positive/neutral/negative)
    - Badge: green text for positive, red text for negative, grey text for neutral
    - Each comment in list: sentiment label (colored) + comment text
    - No pagination — show all comments (deferred per CONTEXT.md)
    - No timestamps in comment list (Claude's discretion — keep UI clean)

    ```typescript
    "use client";

    import { useState, useEffect } from "react";
    import type { Comment } from "@/types/comment";

    export function CommentSection({ playerId }: { playerId: string }) {
      const [comments, setComments] = useState<Comment[]>([]);
      const [text, setText] = useState("");
      const [submitting, setSubmitting] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [loading, setLoading] = useState(true);

      // Load existing comments on mount
      useEffect(() => {
        fetch(`/api/comments?playerId=${encodeURIComponent(playerId)}`)
          .then((r) => r.json())
          .then((data: { comments: Comment[] }) => {
            setComments(data.comments ?? []);
          })
          .catch(() => {
            // Silently fail — empty list is acceptable fallback
          })
          .finally(() => setLoading(false));
      }, [playerId]);

      async function handleSubmit(e: React.FormEvent) {
        e.preventDefault();
        if (!text.trim() || submitting) return;
        setSubmitting(true);
        setError(null);
        try {
          const res = await fetch("/api/comments", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ playerId, text: text.trim() }),
          });
          if (res.status === 503) {
            const data = await res.json();
            setError(
              data.error ??
                "Sentiment service is warming up. Please try again in 30 seconds."
            );
            return;
          }
          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            setError(data.error ?? "Could not submit comment. Please try again.");
            return;
          }
          const data: { comment: Comment } = await res.json();
          setComments((prev) => [...prev, data.comment]);
          setText("");
        } catch {
          setError("Could not submit comment. Please try again.");
        } finally {
          setSubmitting(false);
        }
      }

      // Derive sentiment counts for the badge
      const counts = { positive: 0, neutral: 0, negative: 0 };
      for (const c of comments) {
        counts[c.sentiment] = (counts[c.sentiment] ?? 0) + 1;
      }

      return (
        <section className="mt-10">
          {/* Sentiment summary badge — appears below photo area since this section
              follows the two-column hero grid in the page layout */}
          <div className="flex flex-wrap gap-4 mb-8 p-4 bg-gray-50 rounded-xl border border-gray-200">
            <h2 className="w-full text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">
              Fan Sentiment
            </h2>
            <span className="flex items-center gap-1.5 text-green-600 font-bold text-lg">
              <span className="inline-block w-2.5 h-2.5 rounded-full bg-green-500" />
              {counts.positive} Positive
            </span>
            <span className="flex items-center gap-1.5 text-gray-400 font-bold text-lg">
              <span className="inline-block w-2.5 h-2.5 rounded-full bg-gray-400" />
              {counts.neutral} Neutral
            </span>
            <span className="flex items-center gap-1.5 text-red-600 font-bold text-lg">
              <span className="inline-block w-2.5 h-2.5 rounded-full bg-red-500" />
              {counts.negative} Negative
            </span>
          </div>

          {/* Comment form */}
          <div className="mb-8">
            <h2 className="text-xl font-bold text-kkr-purple mb-4">
              Leave a Comment
            </h2>
            <form onSubmit={handleSubmit} className="flex flex-col gap-3">
              <textarea
                value={text}
                onChange={(e) => setText(e.target.value)}
                placeholder="Share your thoughts about this player..."
                className="w-full border border-gray-300 rounded-xl p-3 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-kkr-purple"
                rows={3}
                disabled={submitting}
              />
              {error && (
                <p className="text-red-500 text-sm">{error}</p>
              )}
              <button
                type="submit"
                disabled={submitting || !text.trim()}
                className="self-start bg-kkr-purple text-white px-5 py-2 rounded-lg text-sm font-semibold disabled:opacity-50 hover:bg-kkr-purple-dark transition-colors"
              >
                {submitting ? "Posting..." : "Post Comment"}
              </button>
            </form>
          </div>

          {/* Comment list */}
          <div>
            <h2 className="text-xl font-bold text-kkr-purple mb-4">
              Comments {!loading && `(${comments.length})`}
            </h2>
            {loading ? (
              <p className="text-gray-400 text-sm">Loading comments...</p>
            ) : comments.length === 0 ? (
              <p className="text-gray-400 text-sm">
                No comments yet. Be the first to share your thoughts!
              </p>
            ) : (
              <ul className="space-y-3">
                {comments.map((c) => (
                  <li
                    key={c.id}
                    className="border border-gray-200 rounded-xl p-4 text-sm bg-white"
                  >
                    <span
                      className={`inline-block font-semibold text-xs uppercase tracking-wider px-2 py-0.5 rounded-full mb-2 ${
                        c.sentiment === "positive"
                          ? "bg-green-100 text-green-700"
                          : c.sentiment === "negative"
                          ? "bg-red-100 text-red-700"
                          : "bg-gray-100 text-gray-500"
                      }`}
                    >
                      {c.sentiment}
                    </span>
                    <p className="text-gray-700 leading-relaxed">{c.text}</p>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </section>
      );
    }
    ```
  </action>
  <verify>npx tsc --noEmit — no TypeScript errors in CommentSection.tsx</verify>
  <done>src/components/CommentSection.tsx exists; exports CommentSection; "use client" directive at top; imports Comment from @/types/comment; fetches from /api/comments on mount; submits to POST /api/comments; shows sentiment badge with green/red/grey counts; shows comment list with colored sentiment labels</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CommentSection into the player profile page</name>
  <files>
    src/app/players/[slug]/page.tsx
  </files>
  <action>
    Update `src/app/players/[slug]/page.tsx` to import and render CommentSection below the two-column hero grid.

    **IMPORTANT placement rule (from research Pitfall 6):** Add `<CommentSection>` AFTER the closing `</div>` of the `grid grid-cols-1 md:grid-cols-2` div — NOT inside either column. It must be a full-width sibling, not a nested child of the grid.

    The page is a pure server component — no "use client" needed. Importing a client component into a server component is valid Next.js App Router pattern.

    The `slug` from `params` is the `playerId` to pass to CommentSection.

    Changes to make:
    1. Add import: `import { CommentSection } from "@/components/CommentSection";`
    2. After the closing `</div>` of the two-column grid (line ~97), add `<CommentSection playerId={slug} />`

    The `generateStaticParams` export can stay — it is still valid in server mode (Next.js will prerender known player pages). However, the `generateStaticParams` comment should be updated since it no longer applies to static export:

    Updated file structure:

    ```typescript
    import { players, getPlayerBySlug } from "@/data/players";
    import { notFound } from "next/navigation";
    import { CommentSection } from "@/components/CommentSection";

    // Pre-renders known player slugs at build time for fast initial load
    export function generateStaticParams() {
      return players.map((player) => ({ slug: player.id }));
    }

    export async function generateMetadata({
      params,
    }: {
      params: Promise<{ slug: string }>;
    }) {
      const { slug } = await params;
      const player = getPlayerBySlug(slug);
      return {
        title: player ? `${player.name} | KKR Squad` : "Player Not Found",
      };
    }

    export default async function PlayerPage({
      params,
    }: {
      params: Promise<{ slug: string }>;
    }) {
      const { slug } = await params;
      const player = getPlayerBySlug(slug);

      if (!player) notFound();

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          {/* Back link */}
          <a
            href="/players"
            className="inline-flex items-center gap-1 text-kkr-purple hover:text-kkr-purple-light font-medium mb-8 transition-colors"
          >
            ← Back to Squad
          </a>

          {/* Hero: two-column on desktop, stacked on mobile */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            {/* LEFT — Photo area */}
            <div className="relative">
              <img
                src={player.imageUrl}
                alt={player.name}
                className="w-full aspect-square object-cover rounded-2xl bg-kkr-purple-light"
              />
              {/* Jersey number badge */}
              <div className="absolute bottom-4 right-4 bg-kkr-purple-dark text-kkr-gold font-black text-4xl px-3 py-1 rounded-lg">
                #{player.jerseyNumber}
              </div>
            </div>

            {/* RIGHT — Bio details */}
            <div className="flex flex-col gap-5">
              {/* Player name */}
              <h1 className="text-4xl font-extrabold text-kkr-purple">
                {player.name}
              </h1>

              {/* Role badge */}
              <span className="bg-kkr-purple text-kkr-gold text-sm font-semibold px-3 py-1 rounded-full inline-block w-fit">
                {player.role}
              </span>

              {/* Bio */}
              <p className="text-gray-600 text-base leading-relaxed">{player.bio}</p>

              {/* Stats grid */}
              <div className="grid grid-cols-2 gap-4 mt-2">
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wider mb-1">
                    Nationality
                  </p>
                  <p className="text-xl font-bold text-kkr-purple">
                    {player.nationality}
                  </p>
                </div>
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wider mb-1">
                    Age
                  </p>
                  <p className="text-xl font-bold text-kkr-purple">{player.age}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-400 uppercase tracking-wider mb-1">
                    Jersey Number
                  </p>
                  <p className="text-xl font-bold text-kkr-purple">
                    #{player.jerseyNumber}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Comments and sentiment — full width below the hero grid */}
          <CommentSection playerId={slug} />
        </div>
      );
    }
    ```
  </action>
  <verify>
    `npm run build` completes without errors.
    Visit http://localhost:3000/players/rohit-sharma (or any valid player slug) in dev — CommentSection appears below the hero grid with "Fan Sentiment" badge and comment form.
  </verify>
  <done>Player profile page imports CommentSection; CommentSection renders below the two-column hero grid as a full-width element; npm run build succeeds; player profile still shows player data correctly</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across all new files
2. `npm run build` completes without errors
3. `npm run dev` starts successfully
4. Visit /players/any-valid-slug — see hero grid AND CommentSection below it
5. CommentSection shows "Fan Sentiment" badge (0 Positive, 0 Neutral, 0 Negative initially)
6. Comment form has textarea and "Post Comment" button
7. Comment list shows "No comments yet" message when empty
</verification>

<success_criteria>
- src/components/CommentSection.tsx created with "use client" directive
- CommentSection fetches GET /api/comments on mount and displays existing comments
- CommentSection submits POST /api/comments on form submission with loading state
- Sentiment badge shows green/red/grey counts derived from loaded comments
- Each comment in list shows colored sentiment label pill + comment text
- HF 503 cold-start error and network errors shown as user-friendly messages
- Player profile page imports and renders CommentSection after the hero grid (full-width)
- npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-player-comments-and-sentiment/04-02-SUMMARY.md`
</output>
