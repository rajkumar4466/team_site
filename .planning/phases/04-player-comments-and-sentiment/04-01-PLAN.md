---
phase: 04-player-comments-and-sentiment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/types/comment.ts
  - src/data/comments.ts
  - src/app/api/comments/route.ts
  - .env.local.example
autonomous: true
requirements:
  - COMM-01
  - COMM-02

must_haves:
  truths:
    - "POST /api/comments accepts {playerId, text} and returns a classified comment"
    - "GET /api/comments?playerId=X returns all comments for that player"
    - "Sentiment classification uses lxyuan/distilbert-base-multilingual-cased-sentiments-student via HuggingFace Inference API"
    - "HuggingFace API key is never exposed to the browser — only used in server-side Route Handler"
    - "next build succeeds (output: 'export' removed, POST Route Handler no longer blocked)"
  artifacts:
    - path: "next.config.ts"
      provides: "Server mode enabled (output: 'export' removed)"
      contains: "trailingSlash: true"
    - path: "src/types/comment.ts"
      provides: "Comment and Sentiment type definitions"
      exports: ["Comment", "Sentiment"]
    - path: "src/data/comments.ts"
      provides: "In-memory comment store with getter and adder"
      exports: ["getCommentsByPlayer", "addComment"]
    - path: "src/app/api/comments/route.ts"
      provides: "GET and POST route handlers for comment operations"
      exports: ["GET", "POST"]
    - path: ".env.local.example"
      provides: "Template showing HUGGINGFACE_API_KEY env var"
  key_links:
    - from: "src/app/api/comments/route.ts"
      to: "https://api-inference.huggingface.co/models/lxyuan/distilbert-base-multilingual-cased-sentiments-student"
      via: "server-side fetch in POST handler"
      pattern: "api-inference.huggingface.co/models/lxyuan"
    - from: "src/app/api/comments/route.ts"
      to: "src/data/comments.ts"
      via: "addComment / getCommentsByPlayer imports"
      pattern: "from.*@/data/comments"
---

<objective>
Enable server-side comment infrastructure for Phase 4.

Purpose: This plan removes the `output: 'export'` static export constraint that blocks POST Route Handlers, creates the Comment type definitions and in-memory store, and implements the `/api/comments` route that handles comment submission (including HuggingFace sentiment classification) and comment retrieval.

Output: Working API at `/api/comments` (GET + POST), type-safe comment store, and HUGGINGFACE_API_KEY wired into the Route Handler.
</objective>

<execution_context>
@/Users/mithra_sundaram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mithra_sundaram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/players/[slug]/page.tsx
@next.config.ts

<interfaces>
<!-- Current next.config.ts — must have output: 'export' removed -->
```typescript
// next.config.ts (CURRENT — before this plan)
const nextConfig: NextConfig = {
  output: 'export',      // REMOVE THIS LINE — blocks POST Route Handlers
  trailingSlash: true,
  images: { unoptimized: true },
}
```

<!-- HuggingFace Inference API response shape (text-classification) -->
```typescript
// HF response: array-of-arrays — always index [0] for single input
// [[{label: "positive", score: 0.97}, {label: "neutral", score: 0.02}, {label: "negative", score: 0.01}]]
type HFTextClassificationResponse = Array<Array<{ label: string; score: number }>>;
// Take highest-score label: scores.reduce((a, b) => a.score > b.score ? a : b).label
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove static export and create Comment types + in-memory store</name>
  <files>
    next.config.ts
    src/types/comment.ts
    src/data/comments.ts
    .env.local.example
  </files>
  <action>
    **next.config.ts:** Remove the `output: 'export'` line. Keep `trailingSlash: true` and `images: { unoptimized: true }`. Add a comment explaining why it was removed:

    ```typescript
    import type { NextConfig } from 'next'

    const nextConfig: NextConfig = {
      // output: 'export' removed — Phase 4 requires POST Route Handlers for comment submission
      // and server-side HuggingFace API calls. The existing pages still use generateStaticParams
      // and will be statically optimized by Next.js automatically.
      trailingSlash: true,
      images: {
        unoptimized: true,
      },
    }

    export default nextConfig
    ```

    **src/types/comment.ts:** Create type definitions. Pure type exports, no implementation:

    ```typescript
    export type Sentiment = "positive" | "neutral" | "negative";

    export interface Comment {
      id: string;
      playerId: string;
      text: string;
      sentiment: Sentiment;
      createdAt: string; // ISO 8601 string
    }
    ```

    **src/data/comments.ts:** Module-level in-memory Map. Comments persist within the Node.js process lifetime (resets on server restart — acceptable for dev demo). Import types from `@/types/comment`:

    ```typescript
    import type { Comment, Sentiment } from "@/types/comment";

    // Module-level Map persists across requests within the same process.
    // NOTE: Data resets on server restart (next dev restart or next start restart).
    // This is acceptable for a development/demo fan site.
    const store = new Map<string, Comment[]>();

    export function getCommentsByPlayer(playerId: string): Comment[] {
      return store.get(playerId) ?? [];
    }

    export function addComment(
      playerId: string,
      text: string,
      sentiment: Sentiment
    ): Comment {
      const comment: Comment = {
        id: crypto.randomUUID(),
        playerId,
        text,
        sentiment,
        createdAt: new Date().toISOString(),
      };
      const existing = store.get(playerId) ?? [];
      store.set(playerId, [...existing, comment]);
      return comment;
    }
    ```

    **.env.local.example:** Template file documenting required env vars. NEVER create or modify `.env.local` itself (contains secrets):

    ```
    # HuggingFace Inference API token
    # Generate at: https://huggingface.co/settings/tokens/new?ownUserPermissions=inference.serverless.write&tokenType=fineGrained
    # Required permission: "Inference Providers" (serverless write)
    # Free tier: ~$0.10/month credits (as of 2026)
    HUGGINGFACE_API_KEY=hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    ```
  </action>
  <verify>npx tsc --noEmit from project root — no TypeScript errors in new type/data files</verify>
  <done>next.config.ts has no `output: 'export'` line; src/types/comment.ts exports Comment and Sentiment; src/data/comments.ts exports getCommentsByPlayer and addComment; .env.local.example documents HUGGINGFACE_API_KEY</done>
</task>

<task type="auto">
  <name>Task 2: Create /api/comments Route Handler with HuggingFace sentiment classification</name>
  <files>
    src/app/api/comments/route.ts
  </files>
  <action>
    Create `src/app/api/comments/route.ts` with GET and POST handlers.

    **GET handler:** Reads `playerId` from query params, returns comments array. Returns 400 if playerId missing.

    **POST handler:** Accepts `{ playerId: string, text: string }` body. Calls HuggingFace Inference API server-side (API key never leaves the server). Handles HF cold start (503 with `estimated_time`). Stores classified comment and returns it.

    IMPORTANT: Use model `lxyuan/distilbert-base-multilingual-cased-sentiments-student` — NOT `rajkumar4466/bert-sentiment-classifier` (that model is not deployed on HF Inference API and returns errors).

    ```typescript
    import { NextRequest, NextResponse } from "next/server";
    import { addComment, getCommentsByPlayer } from "@/data/comments";
    import type { Sentiment } from "@/types/comment";

    const HF_MODEL_URL =
      "https://api-inference.huggingface.co/models/lxyuan/distilbert-base-multilingual-cased-sentiments-student";

    // GET /api/comments?playerId=rohit-sharma
    export async function GET(request: NextRequest) {
      const playerId = request.nextUrl.searchParams.get("playerId");
      if (!playerId) {
        return NextResponse.json(
          { error: "playerId query parameter is required" },
          { status: 400 }
        );
      }
      const comments = getCommentsByPlayer(playerId);
      return NextResponse.json({ comments });
    }

    // POST /api/comments
    // Body: { playerId: string, text: string }
    export async function POST(request: NextRequest) {
      let playerId: string;
      let text: string;

      try {
        const body = await request.json();
        playerId = body.playerId;
        text = body.text;
      } catch {
        return NextResponse.json({ error: "Invalid JSON body" }, { status: 400 });
      }

      if (!playerId || !text || typeof playerId !== "string" || typeof text !== "string") {
        return NextResponse.json(
          { error: "playerId and text are required strings" },
          { status: 400 }
        );
      }

      if (!text.trim()) {
        return NextResponse.json({ error: "Comment text cannot be empty" }, { status: 400 });
      }

      // Call HuggingFace Inference API server-side — API key never reaches the browser
      let sentiment: Sentiment = "neutral"; // fallback if HF call fails
      try {
        const hfResponse = await fetch(HF_MODEL_URL, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${process.env.HUGGINGFACE_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ inputs: text.trim() }),
        });

        // Handle cold start: HF returns 503 with estimated_time when model is loading
        if (hfResponse.status === 503) {
          const errBody = await hfResponse.json().catch(() => ({}));
          if ("estimated_time" in errBody) {
            return NextResponse.json(
              {
                error:
                  "Sentiment service is warming up. Please try again in 30 seconds.",
                estimated_time: errBody.estimated_time,
              },
              { status: 503 }
            );
          }
        }

        if (hfResponse.ok) {
          // Response shape: [[{label: string, score: number}, ...]]
          // Outer array = batch; [0] = first (only) input's scores
          const hfData: Array<Array<{ label: string; score: number }>> =
            await hfResponse.json();
          const scores = hfData[0];
          const winner = scores.reduce((a, b) => (a.score > b.score ? a : b));
          const label = winner.label.toLowerCase();
          if (label === "positive" || label === "negative" || label === "neutral") {
            sentiment = label as Sentiment;
          }
        }
        // If HF call fails for any other reason, fall through with "neutral" sentiment
      } catch {
        // Network error or JSON parse error — store comment with "neutral" sentiment
        // rather than failing the entire submission
      }

      const comment = addComment(playerId, text.trim(), sentiment);
      return NextResponse.json({ comment }, { status: 201 });
    }
    ```
  </action>
  <verify>
    Run: `curl -s -X POST http://localhost:3000/api/comments -H "Content-Type: application/json" -d '{"playerId":"test","text":"Great player!"}' | head -c 200`
    (requires `npm run dev` running and HUGGINGFACE_API_KEY set in .env.local)
    Also run: `npx tsc --noEmit` — no TypeScript errors
  </verify>
  <done>GET /api/comments?playerId=X returns {comments: []} for unknown players; POST /api/comments returns {comment: {id, playerId, text, sentiment, createdAt}} with status 201; TypeScript compiles cleanly</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `next.config.ts` no longer contains `output: 'export'`
3. `src/types/comment.ts` exports `Comment` interface and `Sentiment` type
4. `src/data/comments.ts` exports `getCommentsByPlayer` and `addComment`
5. `src/app/api/comments/route.ts` exports `GET` and `POST`
6. `.env.local.example` documents `HUGGINGFACE_API_KEY`
7. `npm run build` completes without errors (static pages still build, API route present)
</verification>

<success_criteria>
- next.config.ts has `output: 'export'` removed, server mode enabled
- Comment types defined at src/types/comment.ts
- In-memory store at src/data/comments.ts with getCommentsByPlayer and addComment
- Route handler at src/app/api/comments/route.ts handling GET (retrieve) and POST (classify + store)
- POST uses lxyuan/distilbert-base-multilingual-cased-sentiments-student via HuggingFace Inference API
- HuggingFace API key read from process.env.HUGGINGFACE_API_KEY (server-side only)
- Cold start 503 handled gracefully with user-friendly error
- HF call failure falls back to "neutral" sentiment rather than rejecting the comment
- .env.local.example documents the required env var with token generation URL
</success_criteria>

<output>
After completion, create `.planning/phases/04-player-comments-and-sentiment/04-01-SUMMARY.md`
</output>
